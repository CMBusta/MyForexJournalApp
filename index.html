<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Forex Trading Journal (Offline Ready)</title>
    <link rel="stylesheet" href="./output.css" />
    <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>

    <style>
      /* 7. UI and Design Polish: Custom Scrollbar Styles */
      body {
        font-family: "Inter", sans-serif;
        transition: background-color 0.3s, color 0.3s;
      }

      .scrollable-list {
        max-height: 70vh;
        overflow-y: auto;
        scrollbar-width: thin;
        scrollbar-color: #4f46e5 #f5f7fa;
      }

      .scrollable-list::-webkit-scrollbar {
        width: 8px;
        height: 8px;
      }
      .scrollable-list::-webkit-scrollbar-track {
        background: #f5f7fa;
        border-radius: 10px;
      }
      .scrollable-list::-webkit-scrollbar-thumb {
        background: #4f46e5;
        border-radius: 10px;
      }
      .scrollable-list::-webkit-scrollbar-thumb:hover {
        background: #3730a3;
      }

      /* Dark Mode Styles */
      @media (prefers-color-scheme: dark) {
        .dark-mode-text {
          color: white;
        }

        .dark-mode-bg {
          background-color: #1f2937;
        }

        .scrollable-list::-webkit-scrollbar-track {
          background: #1f2937;
        }
        .scrollable-list::-webkit-scrollbar-thumb {
          background: #3b82f6;
        }
        .scrollable-list::-webkit-scrollbar-thumb:hover {
          background: #2563eb;
        }
      }

      /* Splash Screen Styles */
      #splash-screen {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: #f3f4f6; /* Light background */
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 100;
        transition: opacity 0.7s ease-out;
      }

      @media (prefers-color-scheme: dark) {
        #splash-screen {
          background-color: #1f2937; /* Dark background */
        }
      }

      .splash-ring-container {
        position: relative;
        width: 100px;
        height: 100px;
        margin-bottom: 20px;
      }

      .splash-ring {
        fill: transparent;
        stroke: #6366f1; /* Indigo color */
        stroke-width: 5px;
        stroke-dasharray: 283; /* 2 * PI * 45 (r=45 for 90x90 circle) */
        stroke-dashoffset: 283;
        transition: stroke-dashoffset 0.5s ease-out, stroke 0.3s;
      }

      .splash-percent {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-weight: 600;
        font-size: 1.25rem;
        color: #6366f1; /* Indigo color */
      }
    </style>
  </head>

  <body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200">
    <div id="splash-screen">
      <div class="splash-ring-container">
        <svg viewBox="0 0 100 100" class="w-full h-full">
          <circle
            cx="50"
            cy="50"
            r="45"
            stroke="#e5e7eb"
            stroke-width="5"
            fill="none"
          ></circle>
          <circle
            cx="50"
            cy="50"
            r="45"
            id="splash-ring"
            class="splash-ring"
            transform="rotate(-90 50 50)"
            fill="none"
          ></circle>
        </svg>
        <div id="splash-percent" class="splash-percent">0%</div>
      </div>
      <p id="splash-text" class="text-lg font-medium text-gray-700 dark:text-gray-300">
        Loading...
      </p>
    </div>
    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
      <header class="mb-8 flex flex-col sm:flex-row justify-between items-start sm:items-center">
        <h1 class="text-3xl font-bold text-indigo-600 dark:text-indigo-400">
          Forex Trading Journal
        </h1>
        <div class="flex space-x-2 mt-4 sm:mt-0">
          <button
            id="exportBtn"
            class="bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-150 ease-in-out shadow-md"
          >
            Export CSV
          </button>
          <button
            id="importBtn"
            class="bg-yellow-500 hover:bg-yellow-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-150 ease-in-out shadow-md"
          >
            Import CSV
          </button>
          <button
            id="deleteAllBtn"
            class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-150 ease-in-out shadow-md"
          >
            Clear All Data
          </button>
        </div>
      </header>

      <section
        class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg mb-8"
      >
        <h2 class="text-2xl font-semibold mb-4 text-gray-900 dark:text-gray-100">
          Add New Trade Entry
        </h2>
        <form id="tradeForm" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
          <div>
            <label for="tradeDate" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Date</label>
            <input
              type="date"
              id="tradeDate"
              required
              class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 dark:bg-gray-700 dark:border-gray-600 dark:text-gray-200"
            />
          </div>

          <div>
            <label for="tradeTime" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Time (HH:MM)</label>
            <input
              type="time"
              id="tradeTime"
              class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 dark:bg-gray-700 dark:border-gray-600 dark:text-gray-200"
            />
          </div>

          <div>
            <label for="currencyPair" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Currency Pair</label>
            <input
              type="text"
              id="currencyPair"
              required
              list="pairSuggestions"
              class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 uppercase dark:bg-gray-700 dark:border-gray-600 dark:text-gray-200"
            />
            <datalist id="pairSuggestions">
              </datalist>
          </div>

          <div>
            <label for="timeFrame" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Time Frame</label>
            <select
              id="timeFrame"
              class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 dark:bg-gray-700 dark:border-gray-600 dark:text-gray-200"
            >
              <option value="">Select</option>
              <option value="M1">M1</option>
              <option value="M5">M5</option>
              <option value="M15">M15</option>
              <option value="M30">M30</option>
              <option value="H1">H1</option>
              <option value="H4">H4</option>
              <option value="D1">D1</option>
              <option value="W1">W1</option>
            </select>
          </div>
          
          <div>
            <label for="strategy" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Strategy</label>
            <select
              id="strategy"
              required
              class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 dark:bg-gray-700 dark:border-gray-600 dark:text-gray-200"
            >
              <option value="">Select a Strategy</option>
              </select>
          </div>

          <div>
            <label for="direction" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Direction</label>
            <select
              id="direction"
              required
              class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 dark:bg-gray-700 dark:border-gray-600 dark:text-gray-200"
            >
              <option value="Long">Long</option>
              <option value="Short">Short</option>
            </select>
          </div>

          <div>
            <label for="pips" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Pips Gained/Lost</label>
            <input
              type="number"
              id="pips"
              step="0.1"
              required
              class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 dark:bg-gray-700 dark:border-gray-600 dark:text-gray-200"
            />
          </div>
          
          <div>
            <label for="rMultiple" class="block text-sm font-medium text-gray-700 dark:text-gray-300">R-Multiple</label>
            <input
              type="number"
              id="rMultiple"
              step="0.01"
              required
              class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 dark:bg-gray-700 dark:border-gray-600 dark:text-gray-200"
            />
          </div>

          <div>
            <label for="entryPrice" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Entry Price</label>
            <input
              type="number"
              id="entryPrice"
              step="0.00001"
              class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 dark:bg-gray-700 dark:border-gray-600 dark:text-gray-200"
            />
          </div>

          <div>
            <label for="slPrice" class="block text-sm font-medium text-gray-700 dark:text-gray-300">SL Price</label>
            <input
              type="number"
              id="slPrice"
              step="0.00001"
              class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 dark:bg-gray-700 dark:border-gray-600 dark:text-gray-200"
            />
          </div>

          <div>
            <label for="tpPrice" class="block text-sm font-medium text-gray-700 dark:text-gray-300">TP Price</label>
            <input
              type="number"
              id="tpPrice"
              step="0.00001"
              class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 dark:bg-gray-700 dark:border-gray-600 dark:text-gray-200"
            />
          </div>

          <div>
            <label for="exitPrice" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Exit Price</label>
            <input
              type="number"
              id="exitPrice"
              step="0.00001"
              class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 dark:bg-gray-700 dark:border-gray-600 dark:text-gray-200"
            />
          </div>
          
          <div>
            <label for="exitReason" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Exit Reason</label>
            <select
              id="exitReason"
              required
              class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 dark:bg-gray-700 dark:border-gray-600 dark:text-gray-200"
            >
              <option value="">Select Reason</option>
              <option value="SL">Stop Loss (SL)</option>
              <option value="TP">Take Profit (TP)</option>
              <option value="Manual">Manual Exit</option>
              <option value="Break Even">Break Even (BE)</option>
              <option value="Other">Other</option>
            </select>
          </div>

          <div>
            <label for="lotSize" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Lot Size</label>
            <input
              type="number"
              id="lotSize"
              step="0.01"
              class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 dark:bg-gray-700 dark:border-gray-600 dark:text-gray-200"
            />
          </div>
          
          <div>
            <label for="setupGrade" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Setup Grade</label>
            <select
              id="setupGrade"
              class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 dark:bg-gray-700 dark:border-gray-600 dark:text-gray-200"
            >
              <option value="">Select Grade</option>
              <option value="A">A - Excellent</option>
              <option value="B">B - Good</option>
              <option value="C">C - Average</option>
              <option value="D">D - Poor</option>
            </select>
          </div>

          <div>
            <label for="didFollowPlan" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Did Follow Plan</label>
            <select
              id="didFollowPlan"
              class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 dark:bg-gray-700 dark:border-gray-600 dark:text-gray-200"
            >
              <option value="">Select</option>
              <option value="Yes">Yes</option>
              <option value="No">No</option>
              <option value="Some">Some</option>
            </select>
          </div>

          <div>
            <label for="emotionalState" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Emotional State</label>
            <input
              type="text"
              id="emotionalState"
              placeholder="e.g., Calm, Fearful, Doubtful"
              class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 dark:bg-gray-700 dark:border-gray-600 dark:text-gray-200"
            />
          </div>

          <div class="lg:col-span-4 grid grid-cols-1 sm:grid-cols-2 gap-4">
            
            <div>
              <label
                for="preTradeImageFile"
                class="block text-sm font-medium text-gray-700 dark:text-gray-300"
                >Pre-Trade Screenshot (Optional)</label
              >
              <input
                type="file"
                id="preTradeImageFile"
                accept="image/*"
                class="mt-1 block w-full text-sm text-gray-500 dark:text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100 dark:file:bg-gray-700 dark:file:text-indigo-400 dark:file:hover:bg-gray-600"
              />
              <div id="preImagePreviewContainer" class="mt-2 hidden">
                <img id="preImagePreview" class="w-24 h-24 object-cover rounded-md" alt="Pre-Trade Screenshot Preview" />
                <button type="button" id="clearPreImageBtn" class="mt-1 text-xs text-red-500 hover:text-red-700">Remove Image</button>
              </div>
              <input type="hidden" id="preTradeImageData" />
            </div>

            <div>
              <label
                for="postTradeImageFile"
                class="block text-sm font-medium text-gray-700 dark:text-gray-300"
                >Post-Trade Screenshot (Optional)</label
              >
              <input
                type="file"
                id="postTradeImageFile"
                accept="image/*"
                class="mt-1 block w-full text-sm text-gray-500 dark:text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100 dark:file:bg-gray-700 dark:file:text-indigo-400 dark:file:hover:bg-gray-600"
              />
              <div id="postImagePreviewContainer" class="mt-2 hidden">
                <img id="postImagePreview" class="w-24 h-24 object-cover rounded-md" alt="Post-Trade Screenshot Preview" />
                <button type="button" id="clearPostImageBtn" class="mt-1 text-xs text-red-500 hover:text-red-700">Remove Image</button>
              </div>
              <input type="hidden" id="postTradeImageData" />
            </div>
          </div>
          <div class="lg:col-span-2">
            <label for="lessonsLearned" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Lessons Learned (Optional)</label>
            <textarea
              id="lessonsLearned"
              rows="3"
              class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 dark:bg-gray-700 dark:border-gray-600 dark:text-gray-200"
            ></textarea>
          </div>
          
          <div class="lg:col-span-2">
            <label for="notes" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Notes (Optional)</label>
            <textarea
              id="notes"
              rows="3"
              class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 dark:bg-gray-700 dark:border-gray-600 dark:text-gray-200"
            ></textarea>
          </div>

          <input type="hidden" id="entryId" />
          <input type="hidden" id="tradeId" />

          <div class="lg:col-span-4 pt-4 flex space-x-4">
            <button
              type="submit"
              class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg transition duration-150 ease-in-out shadow-lg"
            >
              Save Trade
            </button>
            <button
              type="button"
              id="cancelEditBtn"
              class="flex-1 bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg transition duration-150 ease-in-out shadow-lg hidden"
            >
              Cancel Edit
            </button>
          </div>
        </form>
      </section>

      <section
        id="strategy-section"
        class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg mb-8"
      >
        <h2 class="text-2xl font-semibold mb-4 text-gray-900 dark:text-gray-100">
          Strategy Management
        </h2>
        <form id="strategyForm" class="flex space-x-4 mb-4">
          <input
            type="text"
            id="strategyName"
            placeholder="New Strategy Name (e.g., London Breakout)"
            required
            class="flex-1 rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 dark:bg-gray-700 dark:border-gray-600 dark:text-gray-200"
          />
          <button
            type="submit"
            class="bg-indigo-500 hover:bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-150 ease-in-out shadow-md"
          >
            Add Strategy
          </button>
        </form>
        <ul
          id="strategyList"
          class="space-y-2 scrollable-list p-2 border border-gray-200 dark:border-gray-700 rounded-lg max-h-48 overflow-y-auto"
        >
          </ul>
      </section>

      <section
        class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg"
      >
        <h2 class="text-2xl font-semibold mb-4 text-gray-900 dark:text-gray-100">
          Journal Entries
        </h2>
        <div class="mb-4">
          <input
            type="text"
            id="filterText"
            placeholder="Filter by Pair, Strategy, or Notes..."
            class="w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 dark:bg-gray-700 dark:border-gray-600 dark:text-gray-200"
          />
        </div>
        <div id="entriesList" class="space-y-4 scrollable-list p-2">
          </div>
      </section>

      <div
        id="toast"
        class="fixed bottom-4 right-4 bg-indigo-600 text-white p-3 rounded-lg shadow-xl hidden transition-opacity duration-300"
      >
        Trade saved successfully!
      </div>
    </div>

    <script>
      // =========================================================================================================================
      // 1. SQLite Helpers (Replaces IndexedDB logic)
      // =========================================================================================================================

      const DB_NAME = "ForexJournalDB";
      const STORE_ENTRIES = "entries";
      const STORE_STRATEGIES = "strategies";

      let db;

      // Helper to safely get the plugin (assuming standard Capacitor plugin global access)
      const getSqlitePlugin = () => {
          if (window.Capacitor?.Plugins?.Sqlite) {
              return window.Capacitor.Plugins.Sqlite;
          } else {
              // Dummy implementation for web/testing where plugin is not available
              console.warn("Capacitor SQLite Plugin not available. Using a dummy implementation.");
              return {
                  open: async () => ({ database: DB_NAME }),
                  execute: async (options) => { console.log("Dummy Execute:", options.statements); return { changes: { changes: 0 } }; },
                  query: async (options) => { console.log("Dummy Query:", options.statement); return { values: [] }; },
                  close: async () => { console.log("Dummy Close."); },
                  run: async (options) => { console.log("Dummy Run:", options.statement); return { changes: { changes: 0 } }; },
                  isDatabase: async () => ({ result: false }),
                  dropDatabase: async () => { console.log("Dummy Drop."); },
              };
          }
      };

      const Sqlite = getSqlitePlugin();

      /**
       * Generates a simple, unique ID for tradeId.
       * @returns {string}
       */
      function generateTradeId() {
          return Math.random().toString(36).substring(2, 9);
      }
      
      /**
       * Open the SQLite database and initialize the tables with the full CSV structure,
       * now including preTradeImage.
       */
      async function openDB() {
          try {
              const { database } = await Sqlite.open({
                  database: DB_NAME,
                  encrypted: false,
                  mode: 'full',
                  version: 1,
                  readonly: false
              });
              db = database;

              // SQL statements to create tables if they do not exist
              // *** UPDATED: Added preTradeImage TEXT column ***
              const statements = `
                  CREATE TABLE IF NOT EXISTS ${STORE_ENTRIES} (
                      id INTEGER PRIMARY KEY,
                      tradeId TEXT,
                      date TEXT NOT NULL,
                      time TEXT,
                      pair TEXT NOT NULL,
                      direction TEXT NOT NULL,
                      strategy TEXT NOT NULL,
                      timeFrame TEXT,
                      entryPrice REAL,
                      slPrice REAL,
                      tpPrice REAL,
                      exitPrice REAL,
                      exitReason TEXT,
                      pips REAL,
                      lotSize REAL,
                      rMultiple REAL,
                      setupGrade TEXT,
                      didFollowPlan TEXT,
                      emotionalState TEXT,
                      lessonsLearned TEXT,
                      notes TEXT,
                      preTradeImage TEXT,
                      postTradeImage TEXT,
                      timestamp INTEGER NOT NULL
                  );
                  CREATE TABLE IF NOT EXISTS ${STORE_STRATEGIES} (
                      name TEXT PRIMARY KEY NOT NULL,
                      description TEXT
                  );
              `;

              await Sqlite.execute({ database: db, statements: statements });
              console.log("SQLite Database initialized with full schema (including preTradeImage).");
          } catch (err) {
              console.error("SQLite Initialization failed:", err);
              throw err;
          }
      }

      /**
       * Saves an item to a store (table).
       * If item.id is provided, it attempts to update (using UPDATE).
       * @param {string} storeName - The name of the table (STORE_ENTRIES or STORE_STRATEGIES).
       * @param {Object} item - The object to save.
       */
      async function addItem(storeName, item) {
          if (storeName === STORE_ENTRIES) {
              // *** UPDATED: Added preTradeImage to columns ***
              const columns = [
                  "tradeId", "date", "time", "pair", "direction", "strategy", "timeFrame",
                  "entryPrice", "slPrice", "tpPrice", "exitPrice", "exitReason", "pips",
                  "lotSize", "rMultiple", "setupGrade", "didFollowPlan", "emotionalState",
                  "lessonsLearned", "notes", "preTradeImage", "postTradeImage", "timestamp"
              ];
              
              const values = columns.map(col => item[col] || null);
              
              if (item.id) {
                  // Update mode
                  const setClauses = columns.map(col => `${col}=?`).join(', ');
                  const sql = `UPDATE ${STORE_ENTRIES} SET ${setClauses} WHERE id=?`;
                  
                  // Append id for the WHERE clause
                  values.push(item.id);

                  const result = await Sqlite.run({ database: db, statement: sql, values: values });
                  return item.id;
              } else {
                  // Insert mode
                  const columnNames = columns.join(', ');
                  const placeholders = values.map(() => '?').join(', ');
                  const sql = `INSERT INTO ${STORE_ENTRIES} (${columnNames}) VALUES (${placeholders})`;

                  const result = await Sqlite.run({ database: db, statement: sql, values: values });
                  return result.changes.lastId;
              }
          } else if (storeName === STORE_STRATEGIES) {
              // Save a strategy. Name is the primary key.
              const sql = `INSERT OR REPLACE INTO ${STORE_STRATEGIES} (name, description) VALUES (?, ?)`;
              await Sqlite.run({ database: db, statement: sql, values: [item.name, item.description || null] });
              return item.name;
          }
      }

      /**
       * Retrieves all items from a store (table).
       * @param {string} storeName - The name of the table.
       * @returns {Promise<Array<Object>>} - The list of items.
       */
      async function getAll(storeName) {
          let orderBy = '';
          if (storeName === STORE_ENTRIES) {
              orderBy = 'ORDER BY timestamp DESC';
          }
          const sql = `SELECT * FROM ${storeName} ${orderBy}`;
          const result = await Sqlite.query({ database: db, statement: sql, values: [] });

          return result.values || [];
      }

      /**
       * Deletes an item from a store (table) by its key (id or name).
       * @param {string} storeName - The name of the table.
       * @param {*} key - The key (id for entries, name for strategies).
       */
      async function deleteItem(storeName, key) {
          const keyColumn = storeName === STORE_ENTRIES ? 'id' : 'name';
          const sql = `DELETE FROM ${storeName} WHERE ${keyColumn} = ?`;
          await Sqlite.run({ database: db, statement: sql, values: [key] });
      }

      // =========================================================================================================================
      // 2. State & DOM References
      // =========================================================================================================================

      let journalEntries = [];
      let tradingStrategies = [];
      let currencyPairs = [];

      const tradeForm = document.getElementById("tradeForm");
      const strategyForm = document.getElementById("strategyForm");
      const entriesList = document.getElementById("entriesList");
      const strategyList = document.getElementById("strategyList");
      const strategySelect = document.getElementById("strategy");
      const pairSuggestions = document.getElementById("pairSuggestions");

      const exportBtn = document.getElementById("exportBtn");
      const importBtn = document.getElementById("importBtn");
      const deleteAllBtn = document.getElementById("deleteAllBtn");
      const filterText = document.getElementById("filterText");

      // *** UPDATED: References for pre-trade image fields ***
      const preTradeImageFile = document.getElementById("preTradeImageFile");
      const preTradeImageDataField = document.getElementById("preTradeImageData");
      const preImagePreview = document.getElementById("preImagePreview");
      const preImagePreviewContainer = document.getElementById("preImagePreviewContainer");
      const clearPreImageBtn = document.getElementById("clearPreImageBtn");
      
      // Post-trade image references
      const postTradeImageFile = document.getElementById("postTradeImageFile");
      const postTradeImageDataField = document.getElementById("postTradeImageData");
      const postImagePreview = document.getElementById("postImagePreview");
      const postImagePreviewContainer = document.getElementById("postImagePreviewContainer");
      const clearPostImageBtn = document.getElementById("clearPostImageBtn");

      const cancelEditBtn = document.getElementById("cancelEditBtn");

      // =========================================================================================================================
      // 3. Trade Entry Logic
      // =========================================================================================================================

      /**
       * Converts a file (image) to a Base64 string.
       * @param {File} file
       * @returns {Promise<string>}
       */
      function fileToBase64(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = () => resolve(reader.result);
          reader.onerror = (error) => reject(error);
          reader.readAsDataURL(file);
        });
      }

      /**
       * Handles trade form submission (Add/Edit).
       */
      tradeForm.addEventListener("submit", async (e) => {
        e.preventDefault();

        const entryId = document.getElementById("entryId").value;
        
        try {
          
          // Collect all data points from the expanded form
          const date = document.getElementById("tradeDate").value;
          const time = document.getElementById("tradeTime").value || null;
          const pair = document.getElementById("currencyPair").value.toUpperCase();
          const strategy = document.getElementById("strategy").value;
          const direction = document.getElementById("direction").value;
          const timeFrame = document.getElementById("timeFrame").value || null;
          const entryPrice = parseFloat(document.getElementById("entryPrice").value) || null;
          const slPrice = parseFloat(document.getElementById("slPrice").value) || null;
          const tpPrice = parseFloat(document.getElementById("tpPrice").value) || null;
          const exitPrice = parseFloat(document.getElementById("exitPrice").value) || null;
          const exitReason = document.getElementById("exitReason").value || null;
          const pips = parseFloat(document.getElementById("pips").value) || null;
          const lotSize = parseFloat(document.getElementById("lotSize").value) || null;
          const rMultiple = parseFloat(document.getElementById("rMultiple").value) || null;
          const setupGrade = document.getElementById("setupGrade").value || null;
          const didFollowPlan = document.getElementById("didFollowPlan").value || null;
          const emotionalState = document.getElementById("emotionalState").value.trim() || null;
          const lessonsLearned = document.getElementById("lessonsLearned").value.trim() || null;
          const notes = document.getElementById("notes").value.trim() || null;

          // Handle two image fields
          let preTradeImage = preTradeImageDataField.value || null;
          let postTradeImage = postTradeImageDataField.value || null;

          if (preTradeImageFile.files.length > 0) {
            preTradeImage = await fileToBase64(preTradeImageFile.files[0]);
          }
          if (postTradeImageFile.files.length > 0) {
            postTradeImage = await fileToBase64(postTradeImageFile.files[0]);
          }
          
          const existingTradeId = document.getElementById("tradeId").value;
          
          // --- FIX FOR TIMESTAMP ERROR START: Safely determine the timestamp ---
          let entryTimestamp = Date.now();
          let parsedEntryId;

          if (entryId) {
              parsedEntryId = parseInt(entryId);
              // Safely find the existing entry in the local state
              const existingEntry = journalEntries.find(e => e.id === parsedEntryId);
              
              if (existingEntry) {
                  entryTimestamp = existingEntry.timestamp;
              } else {
                  // If not found in local state, we use Date.now() but log a warning.
                  // The update will still proceed using the existing ID, but the timestamp
                  // for sorting might be updated.
                  console.warn(`Trade ID ${parsedEntryId} found in form but not in local state. Using current timestamp for update.`);
                  // Keeping entryTimestamp as Date.now() (its default value).
              }
          }
          // --- FIX FOR TIMESTAMP ERROR END ---


          const newEntry = {
            // Use the safely parsed ID
            id: parsedEntryId || undefined,
            tradeId: existingTradeId || generateTradeId(),
            date,
            time,
            pair,
            direction,
            strategy,
            timeFrame,
            entryPrice,
            slPrice,
            tpPrice,
            exitPrice,
            exitReason,
            pips,
            lotSize,
            rMultiple,
            setupGrade,
            didFollowPlan,
            emotionalState,
            lessonsLearned,
            notes,
            preTradeImage,
            postTradeImage,
            // Use the safely determined timestamp
            timestamp: entryTimestamp,
          };

          // The addItem function handles both INSERT and UPDATE based on 'id' presence
          const newId = await addItem(STORE_ENTRIES, newEntry);
          newEntry.id = newId;

          if (entryId) {
            // Update mode: replace the old entry in the state
            const index = journalEntries.findIndex((e) => e.id === newEntry.id);
            if (index > -1) {
              journalEntries[index] = newEntry;
            }
            showToast("Trade updated successfully!");
          } else {
            // Insert mode: add to the front of the state
            journalEntries.unshift(newEntry);
            showToast("Trade saved successfully!");
          }

          // Update the list of pairs
          updateCurrencyPairs(pair);

          // Reset the form and re-render
          tradeForm.reset();
          resetFormForNewEntry();
          await renderJournalEntries();
          
        } catch (error) { 
          console.error("Error saving/updating entry:", error);
          alert("Error saving trade: " + (error.message || error.name || error));
        }
      });

      /**
       * Initializes image file listeners for preview/clearing.
       * @param {string} prefix - 'pre' or 'post'
       */
      function initSingleImageListeners(prefix) {
        const fileInput = document.getElementById(`${prefix}TradeImageFile`);
        const dataField = document.getElementById(`${prefix}TradeImageData`);
        const preview = document.getElementById(`${prefix}ImagePreview`);
        const container = document.getElementById(`${prefix}ImagePreviewContainer`);
        const clearBtn = document.getElementById(`clear${prefix.charAt(0).toUpperCase() + prefix.slice(1)}ImageBtn`);

        fileInput.addEventListener("change", (e) => {
          const file = e.target.files[0];
          if (file) {
            const reader = new FileReader();
            reader.onload = (e) => {
              preview.src = e.target.result;
              container.classList.remove("hidden");
              dataField.value = ""; // Clear hidden field if new file is selected
            };
            reader.readAsDataURL(file);
          } else {
            container.classList.add("hidden");
            preview.src = "";
          }
        });

        clearBtn.addEventListener("click", () => {
          fileInput.value = "";
          dataField.value = "";
          preview.src = "";
          container.classList.add("hidden");
        });
      }
      
      function initImageListeners() {
          initSingleImageListeners('pre'); // *** NEW: Initialize pre-trade listeners ***
          initSingleImageListeners('post');
      }

      /**
       * Determines the text and color for the trade result based on rMultiple or pips.
       * @param {number} rMultiple - The R-Multiple value.
       * @param {number} pips - The pips value.
       * @returns {Object} { text, class }
       */
      function getTradeResultDisplay(rMultiple, pips) {
          const r = rMultiple || 0;
          const p = pips || 0;
          
          let resultText;
          let resultClass;

          if (r > 0.01 || p > 0.01) { // A win if R-Multiple or Pips is significantly positive
              resultText = 'Win';
              resultClass = "bg-green-100 text-green-800 dark:bg-green-800 dark:text-green-100 border-green-500";
          } else if (r < -0.01 || p < -0.01) { // A loss if R-Multiple or Pips is significantly negative
              resultText = 'Loss';
              resultClass = "bg-red-100 text-red-800 dark:bg-red-800 dark:text-red-100 border-red-500";
          } else {
              resultText = 'Break Even';
              resultClass = "bg-yellow-100 text-yellow-800 dark:bg-yellow-800 dark:text-yellow-100 border-yellow-500";
          }

          return { text: resultText, class: resultClass };
      }

      /**
       * Renders the list of journal entries.
       */
      async function renderJournalEntries() {
        const filterValue = filterText.value.toLowerCase();

        const filteredEntries = journalEntries.filter((entry) => {
          const searchString = `${entry.pair} ${entry.strategy} ${entry.exitReason || ""} ${entry.timeFrame || ""} ${entry.setupGrade || ""} ${entry.emotionalState || ""} ${entry.notes || ""} ${entry.lessonsLearned || ""}`.toLowerCase();
          return searchString.includes(filterValue);
        });

        if (filteredEntries.length === 0) {
          entriesList.innerHTML = `<p class="text-center text-gray-500 dark:text-gray-400">No trades found.</p>`;
          return;
        }

        entriesList.innerHTML = filteredEntries
          .map((entry) => {
            const resultDisplay = getTradeResultDisplay(entry.rMultiple, entry.pips);
            
            // Helper function for display
            const formatValue = (value, unit = "") => value !== null ? `<span class="text-sm text-gray-600 dark:text-gray-300">${value}${unit}</span>` : '';
            
            // Helper to render an image container
            const renderImage = (base64, type) => base64 
                ? `<div class="flex flex-col items-center">
                      <img src="${base64}" alt="${type} Screenshot" class="w-16 h-16 object-cover rounded-md cursor-pointer mb-1" onclick="viewImage('${base64}')" />
                      <span class="text-xs text-gray-500 dark:text-gray-400">${type}</span>
                   </div>`
                : '';

            return `
              <div
                class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg shadow flex flex-col justify-between items-start border-l-4 ${resultDisplay.class.split(' ').pop()}"
              >
                <div class="flex-1 min-w-0 w-full">
                  <div class="flex flex-wrap items-center justify-between mb-2">
                    <div class="flex items-center space-x-3">
                        <span class="text-lg font-bold text-gray-900 dark:text-gray-100">${entry.pair} (${entry.timeFrame || 'N/A'})</span>
                        <span class="px-2 py-0.5 text-xs font-semibold rounded-full ${resultDisplay.class}">
                          ${resultDisplay.text}
                        </span>
                        ${entry.setupGrade ? `<span class="text-xs font-medium bg-indigo-100 text-indigo-800 dark:bg-indigo-800 dark:text-indigo-100 px-2 py-0.5 rounded-full">Grade: ${entry.setupGrade}</span>` : ''}
                    </div>
                    <div class="flex items-center space-x-3 text-sm font-medium">
                        ${entry.rMultiple !== null ? `<span class="text-indigo-700 dark:text-indigo-300">R: ${entry.rMultiple.toFixed(2)}</span>` : ''}
                        ${entry.pips !== null ? `<span class="text-gray-700 dark:text-gray-300">${entry.pips >= 0 ? "+" : ""}${entry.pips} pips</span>` : ''}
                    </div>
                  </div>
                  
                  <p class="text-sm text-indigo-600 dark:text-indigo-400 font-medium mb-1">${entry.strategy} / ${entry.direction}</p>
                  <p class="text-xs text-gray-500 dark:text-gray-400">${entry.date} ${entry.time ? `- ${entry.time}` : ''} | Exit: ${entry.exitReason || 'N/A'} | Plan: ${entry.didFollowPlan || 'N/A'}</p>
                  
                  <div class="grid grid-cols-2 sm:grid-cols-4 gap-2 text-xs text-gray-600 dark:text-gray-400 mt-2">
                    ${formatValue(entry.entryPrice, ' Entry')}
                    ${formatValue(entry.slPrice, ' SL')}
                    ${formatValue(entry.tpPrice, ' TP')}
                    ${formatValue(entry.exitPrice, ' Exit')}
                    ${formatValue(entry.lotSize, ' Lot')}
                    ${entry.emotionalState ? `<span class="italic text-gray-500">State: ${entry.emotionalState}</span>` : ''}
                  </div>
                  
                  ${
                    entry.notes
                      ? `<p class="text-sm text-gray-700 dark:text-gray-300 mt-2"><strong>Notes:</strong> ${entry.notes}</p>`
                      : ""
                  }
                  ${
                    entry.lessonsLearned
                      ? `<p class="text-sm text-yellow-700 dark:text-yellow-300 mt-2"><strong>Lessons:</strong> ${entry.lessonsLearned}</p>`
                      : ""
                  }

                  <div class="flex justify-between items-end mt-3">
                    <div class="flex space-x-4">
                      ${renderImage(entry.preTradeImage, 'Pre')}
                      ${renderImage(entry.postTradeImage, 'Post')}
                    </div>
                    <div class="flex space-x-2">
                        <button
                          onclick="editEntry(${entry.id})"
                          class="text-indigo-600 hover:text-indigo-900 dark:text-indigo-400 dark:hover:text-indigo-200 text-sm font-semibold"
                        >
                          Edit
                        </button>
                        <button
                          onclick="deleteEntry(${entry.id})"
                          class="text-red-600 hover:text-red-900 dark:text-red-400 dark:hover:text-red-200 text-sm font-semibold"
                        >
                          Delete
                        </button>
                    </div>
                  </div>
                </div>
              </div>
            `;
          })
          .join("");
      }

      /**
       * Fills the form with data for editing a trade entry.
       * @param {number} id - The ID of the entry to edit.
       */
      function editEntry(id) {
        const entry = journalEntries.find((e) => e.id === id);
        if (!entry) return;

        // Scroll to the form
        window.scrollTo({ top: 0, behavior: "smooth" });

        // Populate all expanded form fields
        document.getElementById("entryId").value = entry.id;
        document.getElementById("tradeId").value = entry.tradeId; // Keep existing tradeId
        document.getElementById("tradeDate").value = entry.date;
        document.getElementById("tradeTime").value = entry.time || '';
        document.getElementById("currencyPair").value = entry.pair;
        document.getElementById("strategy").value = entry.strategy;
        document.getElementById("direction").value = entry.direction;
        document.getElementById("timeFrame").value = entry.timeFrame || '';
        document.getElementById("entryPrice").value = entry.entryPrice;
        document.getElementById("slPrice").value = entry.slPrice;
        document.getElementById("tpPrice").value = entry.tpPrice;
        document.getElementById("exitPrice").value = entry.exitPrice;
        document.getElementById("exitReason").value = entry.exitReason || '';
        document.getElementById("pips").value = entry.pips;
        document.getElementById("lotSize").value = entry.lotSize;
        document.getElementById("rMultiple").value = entry.rMultiple;
        document.getElementById("setupGrade").value = entry.setupGrade || '';
        document.getElementById("didFollowPlan").value = entry.didFollowPlan || '';
        document.getElementById("emotionalState").value = entry.emotionalState || '';
        document.getElementById("lessonsLearned").value = entry.lessonsLearned || '';
        document.getElementById("notes").value = entry.notes || '';

        // *** UPDATED: Handle Pre-Trade Image ***
        preTradeImageFile.value = ""; 
        if (entry.preTradeImage) {
            preTradeImageDataField.value = entry.preTradeImage;
            preImagePreview.src = entry.preTradeImage;
            preImagePreviewContainer.classList.remove("hidden");
        } else {
            preTradeImageDataField.value = "";
            preImagePreview.src = "";
            preImagePreviewContainer.classList.add("hidden");
        }
        
        // Handle Post-Trade Image
        postTradeImageFile.value = ""; 
        if (entry.postTradeImage) {
          postTradeImageDataField.value = entry.postTradeImage; 
          postImagePreview.src = entry.postTradeImage;
          postImagePreviewContainer.classList.remove("hidden");
        } else {
          postTradeImageDataField.value = "";
          postImagePreview.src = "";
          postImagePreviewContainer.classList.add("hidden");
        }

        // Change button text and show cancel button
        const submitBtn = tradeForm.querySelector('button[type="submit"]');
        submitBtn.textContent = "Update Trade";
        submitBtn.classList.remove("bg-indigo-600");
        submitBtn.classList.add("bg-orange-500", "hover:bg-orange-600");
        cancelEditBtn.classList.remove("hidden");
      }

      /**
       * Deletes a trade entry by ID.
       * @param {number} id - The ID of the entry to delete.
       */
      async function deleteEntry(id) {
        if (!confirm("Are you sure you want to delete this trade entry?")) {
          return;
        }

        try {
          await deleteItem(STORE_ENTRIES, id);
          journalEntries = journalEntries.filter((e) => e.id !== id);
          await renderJournalEntries();
          showToast("Trade deleted.");
        } catch (error) {
          console.error("Error deleting entry:", error);
          alert("Error deleting trade: " + error.message);
        }
      }

      /**
       * Resets the form after editing or canceling an edit.
       */
      function resetFormForNewEntry() {
        document.getElementById("entryId").value = "";
        document.getElementById("tradeId").value = "";
        const submitBtn = tradeForm.querySelector('button[type="submit"]');
        submitBtn.textContent = "Save Trade";
        submitBtn.classList.remove("bg-orange-500", "hover:bg-orange-600");
        submitBtn.classList.add("bg-indigo-600");
        cancelEditBtn.classList.add("hidden");

        // *** UPDATED: Reset both image fields ***
        preTradeImageFile.value = "";
        preTradeImageDataField.value = "";
        preImagePreview.src = "";
        preImagePreviewContainer.classList.add("hidden");
        
        postTradeImageFile.value = "";
        postTradeImageDataField.value = "";
        postImagePreview.src = "";
        postImagePreviewContainer.classList.add("hidden");
        
        document.getElementById("tradeDate").valueAsDate = new Date(); // Reset date to today
        document.getElementById("tradeTime").value = "";
        document.getElementById("timeFrame").value = "";
        document.getElementById("setupGrade").value = "";
        document.getElementById("didFollowPlan").value = "";
        document.getElementById("exitReason").value = "";
      }

      // Filter listener
      filterText.addEventListener("input", renderJournalEntries);
      cancelEditBtn.addEventListener("click", () => {
        tradeForm.reset();
        resetFormForNewEntry();
      });

      // =========================================================================================================================
      // 4. Strategy Management Logic
      // =========================================================================================================================

      /**
       * Handles strategy form submission (Add new strategy).
       */
      strategyForm.addEventListener("submit", async (e) => {
        e.preventDefault();

        const nameInput = document.getElementById("strategyName");
        const name = nameInput.value.trim();

        if (name && !tradingStrategies.some((s) => s.name === name)) {
          const newStrategy = { name: name, description: null };
          try {
            await addItem(STORE_STRATEGIES, newStrategy);
            tradingStrategies.push(newStrategy);
            tradingStrategies.sort((a, b) => a.name.localeCompare(b.name));
            renderStrategies();
            nameInput.value = "";
            showToast(`Strategy '${name}' added.`);
          } catch (error) {
            console.error("Error adding strategy:", error);
            alert("Error adding strategy: " + error.message);
          }
        }
      });

      /**
       * Renders the list of strategies in the management section and updates the select dropdown.
       */
      function renderStrategies() {
        // 1. Render management list
        strategyList.innerHTML = tradingStrategies
          .map(
            (s) => `
              <li class="flex justify-between items-center text-gray-700 dark:text-gray-300 p-2 hover:bg-gray-100 dark:hover:bg-gray-600 rounded-lg">
                <span>${s.name}</span>
                <button
                  onclick="deleteStrategy('${s.name.replace(/'/g, "\\'")}')"
                  class="text-red-500 hover:text-red-700 dark:text-red-400 dark:hover:text-red-300 text-sm font-semibold"
                >
                  Delete
                </button>
              </li>
            `
          )
          .join("");

        // 2. Update trade form dropdown
        strategySelect.innerHTML =
          '<option value="">Select a Strategy</option>' +
          tradingStrategies
            .map((s) => `<option value="${s.name}">${s.name}</option>`)
            .join("");
      }

      /**
       * Deletes a strategy by name.
       * @param {string} name - The name of the strategy to delete.
       */
      async function deleteStrategy(name) {
        // Check if any entries use this strategy
        const isUsed = journalEntries.some((e) => e.strategy === name);

        if (isUsed) {
          alert(
            `Cannot delete strategy "${name}" because it is currently used in one or more trade entries.`
          );
          return;
        }

        if (
          !confirm(`Are you sure you want to delete the strategy: "${name}"?`)
        ) {
          return;
        }

        try {
          await deleteItem(STORE_STRATEGIES, name);
          tradingStrategies = tradingStrategies.filter((s) => s.name !== name);
          renderStrategies();
          showToast(`Strategy '${name}' deleted.`);
        } catch (error) {
          console.error("Error deleting strategy:", error);
          alert("Error deleting strategy: " + error.message);
        }
      }

      // =========================================================================================================================
      // 5. Default Data and Utility Logic
      // =========================================================================================================================

      /**
       * Ensures default strategies are present on first run.
       */
      async function ensureDefaults() {
        if (tradingStrategies.length === 0) {
          const defaultStrategies = [
            { name: "Breakout", description: "Trading on price breaking key levels." },
            { name: "Reversal", description: "Trading on market turning points." },
            { name: "Trend Continuation", description: "Trading in the direction of the main trend." },
          ];

          for (const strategy of defaultStrategies) {
            await addItem(STORE_STRATEGIES, strategy);
          }
          tradingStrategies = defaultStrategies; // Update state after adding
        }
      }

      /**
       * Loads all entries and strategies from the database into state variables.
       */
      async function loadData() {
        tradingStrategies = await getAll(STORE_STRATEGIES);
        journalEntries = await getAll(STORE_ENTRIES);
        updateCurrencyPairs();
      }

      /**
       * Scans entries and populates the currency pair datalist.
       */
      function updateCurrencyPairs(newPair = null) {
        const pairs = new Set(journalEntries.map((e) => e.pair));
        if (newPair) {
          pairs.add(newPair);
        }
        currencyPairs = Array.from(pairs).sort();

        pairSuggestions.innerHTML = currencyPairs
          .map((pair) => `<option value="${pair}">`)
          .join("");
      }

      /**
       * Displays a toast notification.
       * @param {string} message
       */
      function showToast(message) {
        const toast = document.getElementById("toast");
        toast.textContent = message;
        toast.classList.remove("hidden");
        toast.classList.add("opacity-100");

        setTimeout(() => {
          toast.classList.remove("opacity-100");
          toast.classList.add("opacity-0");
          setTimeout(() => toast.classList.add("hidden"), 300);
        }, 3000);
      }

      /**
       * Opens an image in a new tab/window (for viewing full size).
       * @param {string} base64Image
       */
      function viewImage(base64Image) {
        const newWindow = window.open();
        newWindow.document.write(
          `<img src="${base64Image}" style="max-width: 100%; height: auto;" />`
        );
        newWindow.document.title = "Trade Screenshot";
      }

      // =========================================================================================================================
      // 6. Data Import/Export Logic
      // =========================================================================================================================

      /**
       * Exports all trade entries as a CSV file.
       */
      exportBtn.addEventListener("click", () => {
        if (journalEntries.length === 0) {
          alert("No data to export.");
          return;
        }

        const dataToExport = journalEntries.map((entry) => ({
            ID: entry.id,
            tradeId: entry.tradeId,
            date: entry.date,
            time: entry.time,
            pair: entry.pair,
            direction: entry.direction,
            strategy: entry.strategy,
            timeFrame: entry.timeFrame,
            entryPrice: entry.entryPrice,
            slPrice: entry.slPrice,
            tpPrice: entry.tpPrice,
            exitPrice: entry.exitPrice,
            exitReason: entry.exitReason,
            pips: entry.pips,
            lotSize: entry.lotSize,
            rMultiple: entry.rMultiple,
            setupGrade: entry.setupGrade,
            didFollowPlan: entry.didFollowPlan,
            emotionalState: entry.emotionalState,
            lessonsLearned: entry.lessonsLearned,
            notes: entry.notes,
            // *** UPDATED: Include both image columns ***
            preTradeImage: entry.preTradeImage || "",
            postTradeImage: entry.postTradeImage || "",
            timestamp: entry.timestamp,
        }));

        const csv = Papa.unparse(dataToExport);
        const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
        const url = URL.createObjectURL(blob);
        const link = document.createElement("a");
        link.setAttribute("href", url);
        link.setAttribute(
          "download",
          `forex_journal_export_${new Date().toISOString().slice(0, 10)}.csv`
        );
        link.style.visibility = "hidden";
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        showToast("Export successful!");
      });

      /**
       * Handles importing data from a CSV file.
       */
      importBtn.addEventListener("click", () => {
        if (
          !confirm(
            "Importing data will ADD new entries from the CSV. Ensure your CSV is correctly formatted with all the required columns. Continue?"
          )
        ) {
          return;
        }

        const input = document.createElement("input");
        input.type = "file";
        input.accept = ".csv";
        input.onchange = (e) => {
          const file = e.target.files[0];
          if (file) {
            Papa.parse(file, {
              header: true,
              skipEmptyLines: true,
              complete: async (results) => {
                const importedEntries = results.data
                  .filter((row) => row.date && row.pair && row.strategy) // Basic validation
                  .map((row) => ({
                    // We generate a new ID for the SQLite PK but keep the CSV's tradeId
                    tradeId: row.tradeId || generateTradeId(),
                    date: row.date,
                    time: row.time || null,
                    pair: row.pair.toUpperCase(),
                    direction: row.direction || 'Long',
                    strategy: row.strategy,
                    timeFrame: row.timeFrame || null,
                    entryPrice: parseFloat(row.entryPrice) || null,
                    slPrice: parseFloat(row.slPrice) || null,
                    tpPrice: parseFloat(row.tpPrice) || null,
                    exitPrice: parseFloat(row.exitPrice) || null,
                    exitReason: row.exitReason || 'Manual',
                    pips: parseFloat(row.pips) || null,
                    lotSize: parseFloat(row.lotSize) || null,
                    rMultiple: parseFloat(row.rMultiple) || null,
                    setupGrade: row.setupGrade || null,
                    didFollowPlan: row.didFollowPlan || null,
                    emotionalState: row.emotionalState || null,
                    lessonsLearned: row.lessonsLearned || null,
                    notes: row.notes || null,
                    // *** UPDATED: Map both image columns from CSV ***
                    preTradeImage: row.preTradeImage || null, 
                    postTradeImage: row.postTradeImage || null,
                    timestamp: row.timestamp ? parseInt(row.timestamp) : Date.now(),
                  }));

                if (importedEntries.length === 0) {
                  alert("No valid entries found in the CSV file.");
                  return;
                }

                try {
                    let importedCount = 0;
                    for (const entry of importedEntries) {
                        // For imported data, we always treat them as new entries to get a new internal ID
                        const newId = await addItem(STORE_ENTRIES, entry);
                        entry.id = newId;
                        journalEntries.push(entry);
                        importedCount++;

                        // Add new strategies on the fly
                        if (!tradingStrategies.some(s => s.name === entry.strategy)) {
                            const newStrategy = { name: entry.strategy, description: 'Imported Strategy' };
                            await addItem(STORE_STRATEGIES, newStrategy);
                            tradingStrategies.push(newStrategy);
                        }
                    }

                    // Re-sort and re-render everything
                    journalEntries.sort((a, b) => b.timestamp - a.timestamp);
                    tradingStrategies.sort((a, b) => a.name.localeCompare(b.name));

                    updateCurrencyPairs();
                    renderStrategies();
                    await renderJournalEntries();

                    showToast(`Successfully imported ${importedCount} trade entries!`);
                } catch (error) {
                    console.error("Error during import:", error);
                    alert("Error during data import. Check console for details.");
                }
              },
            });
          }
        };
        input.click();
      });

      /**
       * Clears all data from both tables.
       */
      deleteAllBtn.addEventListener("click", async () => {
        if (
          !confirm(
            "WARNING: This action will permanently DELETE ALL trade entries and ALL strategies. Are you absolutely sure you want to continue? This also clears the previously used IndexedDB database."
          )
        ) {
          return;
        }

        try {
          // 1. Clear IndexedDB (to ensure old data is gone)
          await new Promise((resolve, reject) => {
                // Attempt to open and delete the old IndexedDB database
                const DB_REQUEST = indexedDB.open("ForexJournalDB"); // Assuming this was the old IndexedDB name
                DB_REQUEST.onsuccess = (event) => {
                    event.target.result.close();
                    const deleteRequest = indexedDB.deleteDatabase("ForexJournalDB");
                    deleteRequest.onsuccess = () => {
                        console.log("Old IndexedDB cleared.");
                        resolve();
                    };
                    deleteRequest.onerror = (e) => {
                         // This is often a non-critical error, e.g. if the old DB didn't exist
                        console.warn("Could not clear old IndexedDB:", e.target.error);
                        resolve();
                    };
                    deleteRequest.onblocked = () => {
                        console.warn("Could not clear old IndexedDB: Blocked.");
                        resolve();
                    };
                };
                DB_REQUEST.onerror = (e) => {
                    console.warn("Could not open old IndexedDB:", e.target.error);
                    resolve();
                };
            });

          // 2. Clear SQLite DB
          await Sqlite.execute({
              database: db,
              statements: `
                  DELETE FROM ${STORE_ENTRIES};
                  DELETE FROM ${STORE_STRATEGIES};
              `
          });
          
          // Reset state
          journalEntries = [];
          tradingStrategies = [];
          await renderJournalEntries();
          renderStrategies();
          updateCurrencyPairs();
          await ensureDefaults(); // Re-add defaults after clearing

          showToast("All data has been cleared!");
        } catch (error) {
          console.error("Error clearing database:", error);
          alert("Error clearing all data: " + error.message);
        }
      });

      // =========================================================================================================================
      // 7. Initialization
      // =========================================================================================================================

      /**
       * Main initialization function for the app.
       */
      async function init() {
        const splash = document.getElementById("splash-screen");
        const ring = document.getElementById("splash-ring");
        const percentText = document.getElementById("splash-percent");
        const splashText = document.getElementById("splash-text");

        function updateSplash(progress, text) {
          const percent = Math.min(100, progress);
          const dashOffset = 283 - (283 * percent) / 100;
          ring.style.strokeDashoffset = dashOffset;
          percentText.textContent = `${percent}%`;
          splashText.textContent = text;
        }

        try {
          splash.style.display = "flex";
          updateSplash(0, "Opening database...");

          // 1. Open/Create SQLite DB and Tables (with full schema)
          await openDB();
          updateSplash(20, "Loading all data...");

          // 2. Load all data (strategies & entries)
          await loadData();
          updateSplash(40, "Ensuring default strategies...");

          // 3. Add default strategies if necessary
          await ensureDefaults();
          updateSplash(60, "Rendering strategies...");

          // 4. Render Strategies and Update Pair list
          renderStrategies();
          updateSplash(80, "Rendering journal entries...");

          // 5. Render Journal Entries
          await renderJournalEntries();
          updateSplash(90, "Setting up form...");

          // 6. Set default date to today and initialize listeners
          document.getElementById("tradeDate").valueAsDate = new Date();
          initImageListeners(); // Initialize image handlers (now handles pre and post)
          updateSplash(100, "Ready!");
        } catch (err) {
          console.error("Initialization failed:", err);
          splashText.textContent = "Error loading app ";
          ring.classList.add("text-red-500");
        } finally {
          // Short pause for polish
          setTimeout(() => {
            splash.classList.add("opacity-0");
            setTimeout(() => splash.remove(), 700);
          }, 800);
        }
      }

      window.addEventListener("DOMContentLoaded", init);
    </script>
  </body>
</html>